<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Authentification Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        
        /* En-t√™te de navigation */
        .nav-header {
            background: #2563eb;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .nav-back {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease;
        }
        
        .nav-back:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .nav-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .nav-breadcrumb {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        /* Contenu principal */
        .main-content {
            max-width: 600px;
            margin: 30px auto;
            padding: 20px;
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <!-- En-t√™te de navigation -->
    <header class="nav-header">
        <div class="nav-content">
            <a href="../admin/" class="nav-back">
                ‚Üê Retour √† la Console Admin
            </a>
            <div>
                <div class="nav-title">üîß Test Authentification</div>
                <div class="nav-breadcrumb">Console Admin > Tests > Authentification</div>
            </div>
        </div>
    </header>

    <!-- Contenu principal -->
    <div class="main-content">
        <div class="test-container">
            <h1>üîß Test Console Admin</h1>
            <p>Cette page permet de tester les composants de la console d'administration.</p>

        <!-- Test Endpoint Auth -->
        <div class="test-section">
            <h3>1. Test Endpoint d'Authentification</h3>
            <p>Teste si l'endpoint <code>/api/admin/auth.php</code> fonctionne.</p>
            
            <input type="text" id="test-username" placeholder="Username">
            <input type="password" id="test-password" placeholder="Password">
            <button onclick="testAuthEndpoint()">Tester Auth</button>
            
            <div id="auth-result" class="result"></div>
        </div>

        <!-- Test Variables Environnement -->
        <div class="test-section">
            <h3>2. Test Variables d'Environnement</h3>
            <p>V√©rifie si le fichier .env est correctement lu.</p>
            
            <button onclick="testEnvVars()">V√©rifier .env</button>
            
            <div id="env-result" class="result"></div>
        </div>

        <!-- Test API OpenAI -->
        <div class="test-section">
            <h3>3. Test Connexion OpenAI</h3>
            <p>Teste la connectivit√© √† l'API OpenAI.</p>
            
            <button onclick="testOpenAIConnection()">Tester OpenAI</button>
            
            <div id="openai-result" class="result"></div>
        </div>

        <!-- Test Local Storage -->
        <div class="test-section">
            <h3>4. Test Stockage Local</h3>
            <p>Teste le stockage des donn√©es d'usage en local.</p>
            
            <button onclick="testLocalStorage()">Tester Storage</button>
            <button onclick="clearLocalStorage()">Vider Storage</button>
            
            <div id="storage-result" class="result"></div>
        </div>

        <!-- Actions Utiles -->
        <div class="test-section">
            <h3>5. Actions Utiles</h3>
            <button onclick="generateTestData()">G√©n√©rer Donn√©es Test</button>
            <button onclick="clearAllData()">Tout Vider</button>
            <button onclick="showDebugInfo()">Info Debug</button>
        </div>
    </div>
</div>

    <script>
        // Test de l'endpoint d'authentification
        async function testAuthEndpoint() {
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;
            const resultDiv = document.getElementById('auth-result');
            
            resultDiv.textContent = '‚è≥ Test en cours...';
            resultDiv.className = 'result warning';
            
            try {
                const response = await fetch('/api/admin/auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (response.ok && result.valid) {
                    resultDiv.textContent = `‚úÖ AUTH SUCCESS:\n${JSON.stringify(result, null, 2)}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.textContent = `‚ùå AUTH FAILED:\n${JSON.stringify(result, null, 2)}`;
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                resultDiv.textContent = `üí• ENDPOINT ERROR:\n${error.message}\n\n‚ö†Ô∏è L'endpoint PHP n'est peut-√™tre pas configur√© sur ce serveur.`;
                resultDiv.className = 'result error';
            }
        }

        // Test des variables d'environnement (uniformis√©)
        async function testEnvVars() {
            const resultDiv = document.getElementById('env-result');
            resultDiv.textContent = '‚è≥ V√©rification via l\'endpoint de diagnostic...';
            resultDiv.className = 'result warning';
            
            try {
                // Utiliser le nouvel endpoint de diagnostic
                const diagResponse = await fetch('/api/admin/config-test.php');

                if (!diagResponse.ok) {
                    throw new Error(`Erreur HTTP: ${diagResponse.status}`);
                }
                
                const diagData = await diagResponse.json();
                
                if (diagData.success && diagData.debug) {
                    const envVars = diagData.debug.env_vars_found || [];
                    const hasAdminUser = envVars.some(v => v.key === 'ADMIN_USERNAME');
                    const hasAdminPass = envVars.some(v => v.key === 'ADMIN_PASSWORD');
                    
                    let summary = `‚úÖ Diagnostic de configuration r√©ussi !\n\n`;
                    summary += `üìÅ Fichier .env: ${diagData.debug.found_path || 'Non trouv√©'}\n`;
                    summary += `üîë Variables trouv√©es: ${envVars.length}\n`;
                    summary += `üë§ ADMIN_USERNAME: ${hasAdminUser ? '‚úÖ Pr√©sente' : '‚ùå Manquante'}\n`;
                    summary += `üîë ADMIN_PASSWORD: ${hasAdminPass ? '‚úÖ Pr√©sente' : '‚ùå Manquante'}\n\n`;
                    summary += `D√©tails complets:\n${JSON.stringify(diagData.debug, null, 2)}`;
                    
                    resultDiv.textContent = summary;
                    resultDiv.className = 'result success';

                } else {
                    throw new Error('R√©ponse de diagnostic invalide');
                }
                
            } catch (error) {
                resultDiv.textContent = `‚ùå ENV TEST FAILED:\n${error.message}\n\nActions √† faire:\n1. V√©rifier que /api/admin/config-test.php est accessible\n2. V√©rifier les logs du serveur PHP`;
                resultDiv.className = 'result error';
            }
        }

        // Test de la connexion OpenAI
        async function testOpenAIConnection() {
            const resultDiv = document.getElementById('openai-result');
            resultDiv.textContent = '‚è≥ Test connexion OpenAI...';
            resultDiv.className = 'result warning';
            
            try {
                // Test via l'endpoint de diagnostic
                const response = await fetch('/api/admin/config-test.php');
                const data = await response.json();
                
                if (data.debug && data.debug.php_functions.curl_init) {
                     resultDiv.textContent = '‚úÖ CONNECTIVIT√â OK:\nLa fonction cURL est disponible. Le backend peut faire des requ√™tes externes.';
                     resultDiv.className = 'result success';
                } else {
                    resultDiv.textContent = '‚ö†Ô∏è CONNECTIVIT√â PARTIELLE:\nLa fonction cURL n\'est pas disponible. Le backend pourrait avoir des probl√®mes pour contacter OpenAI.';
                    resultDiv.className = 'result warning';
                }
                
            } catch (error) {
                resultDiv.textContent = `‚ùå TEST CONNECTIVIT√â FAILED:\n${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // Test du stockage local
        function testLocalStorage() {
            const resultDiv = document.getElementById('storage-result');
            
            try {
                // Test d'√©criture
                const testData = {
                    test: 'value',
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('admin_test', JSON.stringify(testData));
                
                // Test de lecture
                const retrieved = JSON.parse(localStorage.getItem('admin_test'));
                
                if (retrieved && retrieved.test === 'value') {
                    resultDiv.textContent = `‚úÖ LOCALSTORAGE OK:\n√âcriture et lecture fonctionnelles.\n\nDonn√©es actuelles:\n${JSON.stringify(retrieved, null, 2)}`;
                    resultDiv.className = 'result success';
                } else {
                    throw new Error('Donn√©es corrompues');
                }
                
            } catch (error) {
                resultDiv.textContent = `‚ùå LOCALSTORAGE FAILED:\n${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // Vider le stockage local
        function clearLocalStorage() {
            localStorage.removeItem('admin_test');
            localStorage.removeItem('openai_usage_data');
            localStorage.removeItem('admin_settings');
            document.getElementById('storage-result').textContent = 'üóëÔ∏è Storage vid√©.';
            document.getElementById('storage-result').className = 'result warning';
        }

        // G√©n√©rer des donn√©es de test
        function generateTestData() {
            const today = new Date().toISOString().split('T')[0];
            const testUsageData = {};
            
            // G√©n√©rer 7 jours de donn√©es
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                testUsageData[dateStr] = {
                    requests: Math.floor(Math.random() * 20) + 5,
                    tokens: Math.floor(Math.random() * 5000) + 1000,
                    cost: Math.random() * 2 + 0.5,
                    models: {
                        'gpt-4o-mini': Math.floor(Math.random() * 15) + 3,
                        'gpt-4': Math.floor(Math.random() * 3) + 1
                    }
                };
            }
            
            localStorage.setItem('openai_usage_data', JSON.stringify(testUsageData));
            
            const resultDiv = document.getElementById('storage-result');
            resultDiv.textContent = `‚úÖ DONN√âES TEST G√âN√âR√âES:\n7 jours de donn√©es simul√©es cr√©√©es.\n\nAu total: ${Object.keys(testUsageData).length} jours`;
            resultDiv.className = 'result success';
        }

        // Vider toutes les donn√©es
        function clearAllData() {
            localStorage.clear();
            sessionStorage.clear();
            alert('üóëÔ∏è Toutes les donn√©es locales ont √©t√© vid√©es.');
        }

        // Afficher les infos de debug
        function showDebugInfo() {
            const debugInfo = {
                userAgent: navigator.userAgent,
                localStorage: !!window.localStorage,
                sessionStorage: !!window.sessionStorage,
                fetch: !!window.fetch,
                currentURL: window.location.href,
                storedData: {
                    admin_settings: localStorage.getItem('admin_settings'),
                    usage_data: localStorage.getItem('openai_usage_data') ? 'Present' : 'None'
                }
            };
            
            console.log('DEBUG INFO:', debugInfo);
            alert('üìã Informations de debug affich√©es dans la console');
        }
    </script>
</body>
</html> 