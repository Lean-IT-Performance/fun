<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Backend OpenAI Usage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        
        /* En-t√™te de navigation */
        .nav-header {
            background: #2563eb;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .nav-back {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease;
        }
        
        .nav-back:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .nav-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .nav-breadcrumb {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        /* Contenu principal */
        .main-content {
            margin: 30px auto;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .result {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success {
            border-color: #4caf50;
            background: #e8f5e8;
        }
        .error {
            border-color: #f44336;
            background: #ffeaea;
        }
        .loading {
            border-color: #ff9800;
            background: #fff3e0;
        }
    </style>
</head>
<body>
    <!-- En-t√™te de navigation -->
    <header class="nav-header">
        <div class="nav-content">
            <a href="../admin/" class="nav-back">
                ‚Üê Retour √† la Console Admin
            </a>
            <div>
                <div class="nav-title">üß™ Test Backend OpenAI</div>
                <div class="nav-breadcrumb">Console Admin > Tests > Backend OpenAI</div>
            </div>
        </div>
    </header>

    <!-- Contenu principal -->
    <div class="main-content">
        <div class="container">
            <h1>üß™ Test Backend OpenAI Billing API</h1>
            <p>Cette page permet de tester l'endpoint backend <code>/api/admin/openai-usage.php</code> qui utilise l'API <code>dashboard/billing/usage</code>.</p>

            <div class="test-section">
                <h3>üìã Test 1: Diagnostic de la configuration</h3>
                <p>V√©rifier que le fichier .env est accessible et contient les bonnes variables.</p>
                <button onclick="testEnvFile()">üîç Lancer le diagnostic</button>
                <div id="env-result" class="result" style="display: none;"></div>
            </div>

            <div class="test-section">
                <h3>üåê Test 2: Endpoint de facturation OpenAI</h3>
                <p>Tester l'appel √† l'API de facturation via le backend.</p>
                <div>
                    <label>Date d√©but:</label>
                    <input type="date" id="start-date" value="">
                    <label>Date fin:</label>
                    <input type="date" id="end-date" value="">
                </div>
                <br>
                <button onclick="testOpenAIUsage()">üìä Tester l'API de facturation</button>
                <div id="usage-result" class="result" style="display: none;"></div>
            </div>
            
            <div class="test-section">
                <h3>üìù Logs de Debug</h3>
                <div id="debug-logs" class="result">Pr√™t pour les tests...</div>
            </div>
        </div>
    </div>

    <script>
        // Initialiser les dates par d√©faut
        window.onload = function() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7); // 7 derniers jours
            
            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
        };

        function log(message) {
            const logs = document.getElementById('debug-logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.textContent += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        async function testEnvFile() {
            const resultDiv = document.getElementById('env-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Test en cours...';
            
            log('üîß D√©but du test des variables d\'environnement');

            try {
                // Essayer d'abord l'endpoint de diagnostic sp√©cialis√©
                log('üî¨ Test avec endpoint de diagnostic sp√©cialis√©...');
                
                const diagResponse = await fetch('/api/admin/config-test.php', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (diagResponse.ok) {
                    const diagData = await diagResponse.json();
                    
                    if (diagData.success && diagData.debug) {
                        resultDiv.className = 'result success';
                        
                        const envVars = diagData.debug.env_vars_found || [];
                        const hasOpenAI = envVars.some(v => v.key === 'OPENAI_API_KEY');
                        const hasOrgId = envVars.some(v => v.key === 'OPENAI_ORG_ID');
                        
                        let summary = `‚úÖ Diagnostic de configuration r√©ussi !\n\n`;
                        summary += `üìÅ Fichier .env: ${diagData.debug.found_path || 'Non trouv√©'}\n`;
                        summary += `üîë Variables trouv√©es: ${envVars.length}\n`;
                        summary += `üìã OPENAI_API_KEY: ${hasOpenAI ? '‚úÖ Pr√©sente' : '‚ùå Manquante'}\n`;
                        summary += `üè¢ OPENAI_ORG_ID: ${hasOrgId ? '‚úÖ Pr√©sente' : '‚ö†Ô∏è Manquante (optionnel)'}\n\n`;
                        summary += `D√©tails complets:\n${JSON.stringify(diagData, null, 2)}`;
                        
                        resultDiv.textContent = summary;
                        log('‚úÖ Test diagnostic r√©ussi - configuration analys√©e');
                        return;
                    }
                }
                
                // Fallback : test avec auth.php en mode debug
                log('üîÑ Fallback vers auth.php avec mode debug...');
                
                const response = await fetch('/api/admin/auth.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: 'test', 
                        password: 'test',
                        debug: true  // Activer le mode debug
                    })
                });

                const data = await response.json();
                
                if (data.debug) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Fichier .env accessible via auth.php !\n\nD√©bug info:\n${JSON.stringify(data.debug, null, 2)}`;
                    log('‚úÖ Test .env r√©ussi via auth.php - fichier accessible');
                } else if (data.valid === false && !data.debug) {
                    resultDiv.className = 'result warning';
                    resultDiv.textContent = `‚ö†Ô∏è Mode debug non activ√© avec identifiants de test.\n\nPour tester la configuration .env, utilisez la page test-auth.html avec vos vrais identifiants admin.\n\nOu modifiez temporairement le code pour inclure les infos de debug.`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Pas d'informations de debug disponibles.\n\nR√©ponse: ${JSON.stringify(data, null, 2)}`;
                    log('‚ö†Ô∏è Test .env partiellement r√©ussi - pas de debug');
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
                log(`‚ùå Erreur test .env: ${error.message}`);
            }
        }

        async function testOpenAIUsage() {
            const resultDiv = document.getElementById('usage-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Test API OpenAI Usage en cours...';
            
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            log(`üìä Test API Usage pour la p√©riode ${startDate} ‚Üí ${endDate}`);

            try {
                const headers = { 'Content-Type': 'application/json' };
                const authToken = sessionStorage.getItem('admin_auth_token');
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch('/api/admin/openai-usage.php', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ API Usage fonctionne !\n\nDonn√©es r√©cup√©r√©es:\n- Source: ${data.source}\n- P√©riode: ${data.period.start_date} ‚Üí ${data.period.end_date}\n- Requ√™tes mensuelles: ${data.data.monthlyRequests}\n- Co√ªt mensuel: $${data.data.monthlyCost}\n- Tokens utilis√©s: ${data.data.tokensUsed}\n\nR√©ponse compl√®te:\n${JSON.stringify(data, null, 2)}`;
                    log('‚úÖ Test API Usage r√©ussi - vraies donn√©es r√©cup√©r√©es !');
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Erreur API: ${data.error || 'Erreur inconnue'}\n\nStatut HTTP: ${response.status}\nR√©ponse: ${JSON.stringify(data, null, 2)}`;
                    log(`‚ö†Ô∏è Test API Usage √©chou√©: ${data.error || 'Erreur inconnue'}`);
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Erreur r√©seau: ${error.message}`;
                log(`‚ùå Erreur r√©seau test API Usage: ${error.message}`);
            }
        }

        async function testBackendConfig() {
            const resultDiv = document.getElementById('config-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Test configuration backend...';
            
            log('‚öôÔ∏è Test de la configuration backend');

            try {
                // Test plusieurs endpoints pour v√©rifier la configuration
                const tests = [
                    { name: 'Auth endpoint', url: '/api/admin/auth.php' },
                    { name: 'Usage endpoint', url: '/api/admin/openai-usage.php' }
                ];

                let results = [];
                
                for (const test of tests) {
                    try {
                        const headers = { 'Content-Type': 'application/json' };
                        if (test.url.includes('openai-usage.php')) {
                            const authToken = sessionStorage.getItem('admin_auth_token');
                            if (authToken) {
                                headers['Authorization'] = `Bearer ${authToken}`;
                            }
                        }

                        const response = await fetch(test.url, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify({})
                        });
                        
                        results.push({
                            name: test.name,
                            status: response.status,
                            accessible: true
                        });
                    } catch (error) {
                        results.push({
                            name: test.name,
                            status: 'Error',
                            accessible: false,
                            error: error.message
                        });
                    }
                }

                resultDiv.className = 'result success';
                resultDiv.textContent = `üìã Configuration Backend:\n\n${results.map(r => 
                    `${r.name}: ${r.accessible ? '‚úÖ' : '‚ùå'} (${r.status})`
                ).join('\n')}\n\nD√©tails:\n${JSON.stringify(results, null, 2)}`;
                
                log('‚úÖ Test configuration backend termin√©');

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
                log(`‚ùå Erreur test configuration: ${error.message}`);
            }
        }
    </script>
</body>
</html> 